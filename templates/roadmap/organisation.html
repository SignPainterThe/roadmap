<!doctype html>
<html>
<head>
  <meta charset='utf-8'>
  <title>{{ organisation.name_full }}</title>

{% load staticfiles %}

  <script data-jsfiddle="common" src="{% static 'roadmap/js/jquery.min.js' %}"></script>
  <link data-jsfiddle="common" rel="stylesheet" media="screen" href="{% static 'roadmap/js/handsontable/handsontable.full.css' %}">
  <script data-jsfiddle="common" src="{% static 'roadmap/js/handsontable/handsontable.full.js' %}"></script>

</head>

<body>

          <h2>{{ organisation.name_full }}</h2>

          <p>
            <button name="load">Load</button>
            <button name="save">Save</button>
            <button name="reset">Reset</button>
            <label><input type="checkbox" name="autosave" checked="checked" autocomplete="off"> Autosave</label>
          </p>

          <div id="marks_console" class="console">Click "Load" to load data from server</div>

          <div id="marks_table"></div>

          <script>
            var
              $container = $("#marks_table"),
              $console = $("#marks_console"),
              $parent = $container.parent(),
              csrftoken = '{{ csrf_token }}',
              autosaveNotification,
              hot;

            hot = new Handsontable($container[0], {
              columnSorting: true,
              startRows: 1,
              startCols: 6,
              rowHeaders: true,
              colHeaders: ['Point', 'Mark', 'Fact', 'Check', 'Plan'],
              columns: [
                {data: 'point'},
                {data: 'mark'},
                {data: 'fact'},
                {data: 'check'},
                {data: 'plan'}
              ],
              minSpareCols: 0,
              minSpareRows: 0,
              contextMenu: true,
              /*afterChange: function (change, source) {
                var data;

                if (source === 'loadData' || !$parent.find('input[name=autosave]').is(':checked')) {
                  return;
                }
                data = change[0];

                // transform sorted row to original row
                data[0] = hot.sortIndex[data[0]] ? hot.sortIndex[data[0]][0] : data[0];

                clearTimeout(autosaveNotification);
                $.ajax({
                  url: 'php/save.php',
                  dataType: 'json',
                  type: 'POST',
                  data: {changes: change}, // contains changed cells' data
                  success: function () {
                    $console.text('Autosaved (' + change.length + ' cell' + (change.length > 1 ? 's' : '') + ')');

                    autosaveNotification = setTimeout(function () {
                      $console.text('Changes will be autosaved');
                    }, 1000);
                  }
                });
              }*/
            });

            $parent.find('button[name=load]').click(function () {
              $.ajax({
                url: '{% url 'roadmap:organisation_load' report.id period.id organisation.id %}',
                data: {
                  csrfmiddlewaretoken: csrftoken
                },
                dataType: 'json',
                type: 'POST',
                success: function (res) {
                  var data = res.data;
                  hot.loadData(data);
                  $console.text('Data loaded');
                }
              });
            }).click(); // execute immediately

            $parent.find('button[name=save]').click(function () {
              $.ajax({
                url: '{% url 'roadmap:organisation_save' report.id period.id organisation.id %}',
                data: {
                  data: JSON.stringify({data: hot.getSourceData()}),
                  csrfmiddlewaretoken: csrftoken
                }, // returns all cells' data
                dataType: 'json',
                type: 'POST',
                success: function (res) {
                  if (res.result === 'ok') {
                    $console.text('Data saved');
                    $parent.find('button[name=load]').click();
                  }
                  else {
                    $console.text('Save error');
                  }
                },
                error: function () {
                  $console.text('Save error');
                }
              });
            });

            $parent.find('button[name=reset]').click(function () {
              $.ajax({
                url: 'php/reset.php',
                success: function () {
                  $parent.find('button[name=load]').click();
                },
                error: function () {
                  $console.text('Data reset failed');
                }
              });
            });

            $parent.find('input[name=autosave]').click(function () {
              if ($(this).is(':checked')) {
                $console.text('Changes will be autosaved');
              }
              else {
                $console.text('Changes will not be autosaved');
              }
            });
          </script>

</body>
</html>